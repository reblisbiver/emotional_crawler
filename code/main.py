from login_utils import create_chrome_driver, login_xiaohongshu, login_weibo
from crawler_utils import crawl_xiaohongshu, crawl_weibo
from save_utils import save_text_data
import time

def main():
    """ä¸»ç¨‹åºå…¥å£ï¼ˆä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œï¼šç™»å½•â†’çˆ¬å–â†’ä¸‹ä¸€ä¸ªå¹³å°ï¼‰"""
    # 1. åˆ›å»ºæµè§ˆå™¨é©±åŠ¨ï¼ˆå…¨ç¨‹å¤ç”¨ä¸€ä¸ªé©±åŠ¨ï¼Œé¿å…é‡å¤å¯åŠ¨ï¼‰
    driver = create_chrome_driver()
    driver.implicitly_wait(10)  # å…¨å±€éšå¼ç­‰å¾…
    print("âœ… æµè§ˆå™¨é©±åŠ¨åˆ›å»ºæˆåŠŸï¼Œå¼€å§‹æ‰§è¡Œæµç¨‹...")

    try:
        # # -------------------------- å°çº¢ä¹¦æµç¨‹ï¼šç™»å½•â†’çˆ¬å–ï¼ˆå¿…é¡»å®Œæˆä¸€ä¸ªæ‰ä¸‹ä¸€ä¸ªï¼‰--------------------------
        # print("\n" + "="*60)
        # print("ğŸ“± å¼€å§‹å°çº¢ä¹¦æµç¨‹ï¼ˆç™»å½•â†’çˆ¬å–ï¼‰")
        # print("="*60)
        
        # # å°çº¢ä¹¦ç™»å½•ï¼šæœªå®Œæˆç™»å½•â†’ä¸è¿›å…¥çˆ¬å–ï¼ˆç™»å½•å¤±è´¥ä¼šç›´æ¥ç»ˆæ­¢ç¨‹åºï¼‰
        # login_success = login_xiaohongshu(driver)
        # if login_success:
        #     print("ğŸš€ å°çº¢ä¹¦ç™»å½•å®Œæˆï¼Œå¼€å§‹çˆ¬å–å°çº¢ä¹¦æ•°æ®...")
        #     # å°çº¢ä¹¦çˆ¬å–ï¼šæœªå®Œæˆçˆ¬å–â†’ä¸è¿›å…¥å¾®åšæµç¨‹
        #     xhs_text_data = crawl_xiaohongshu(driver)
        #     # ä¿å­˜å°çº¢ä¹¦æ•°æ®ï¼ˆæ— è®ºæ˜¯å¦çˆ¬å–åˆ°å†…å®¹ï¼Œéƒ½ç®—çˆ¬å–æµç¨‹å®Œæˆï¼‰
        #     save_text_data("xiaohongshu", xhs_text_data)
        #     print(f"âœ… å°çº¢ä¹¦çˆ¬å–å®Œæˆï¼å…±ä¿å­˜ {len(xhs_text_data)} æ¡æ–‡æœ¬æ•°æ®")
        # else:
        #     print("âŒ å°çº¢ä¹¦ç™»å½•å¤±è´¥ï¼Œè·³è¿‡å°çº¢ä¹¦çˆ¬å–")
        #     # è‹¥å°çº¢ä¹¦ç™»å½•å¤±è´¥ï¼Œå¯é€‰æ‹©ç»ˆæ­¢ç¨‹åºæˆ–ç»§ç»­å¾®åšï¼ˆè¿™é‡ŒæŒ‰â€œç»§ç»­â€å¤„ç†ï¼Œå¯æŒ‰éœ€ä¿®æ”¹ï¼‰

        # # -------------------------- å¾®åšæµç¨‹ï¼šæ‰“å¼€æ ‡ç­¾é¡µâ†’ç™»å½•â†’çˆ¬å–ï¼ˆå¿…é¡»å®Œæˆä¸€ä¸ªæ‰ä¸‹ä¸€ä¸ªï¼‰--------------------------
        # print("\n" + "="*60)
        # print("ğŸ“± å¼€å§‹å¾®åšæµç¨‹ï¼ˆæ‰“å¼€æ ‡ç­¾é¡µâ†’ç™»å½•â†’çˆ¬å–ï¼‰")
        # print("="*60)
        
        # # å…³é”®ï¼šå°çº¢ä¹¦çˆ¬å–å®Œæˆåï¼Œæ‰æ‰“å¼€å¾®åšæ ‡ç­¾é¡µï¼ˆé¿å…æå‰æ‰“å¼€ï¼‰
        # print("ğŸ”„ å°çº¢ä¹¦æµç¨‹å®Œæˆï¼Œæ‰“å¼€å¾®åšä¸“å±æ ‡ç­¾é¡µ...")
        # driver.execute_script("window.open('');")
        # driver.switch_to.window(driver.window_handles[-1])  # åˆ‡æ¢åˆ°æ–°æ ‡ç­¾é¡µ
        # time.sleep(1)  # å¹³ç¨³åˆ‡æ¢ï¼Œé¿å…åŠ è½½å†²çª
        
        # å¾®åšç™»å½•ï¼šæœªå®Œæˆç™»å½•â†’ä¸è¿›å…¥çˆ¬å–ï¼ˆç™»å½•å¤±è´¥ä¼šç›´æ¥ç»ˆæ­¢ç¨‹åºï¼‰
        weibo_login_success = login_weibo(driver)
        if weibo_login_success:
            print("ğŸš€ å¾®åšç™»å½•å®Œæˆï¼Œå¼€å§‹çˆ¬å–å¾®åšæ•°æ®...")
            # å¾®åšçˆ¬å–ï¼šæœªå®Œæˆçˆ¬å–â†’ä¸ç»“æŸç¨‹åº
            weibo_text_data = crawl_weibo(driver)
            # ä¿å­˜å¾®åšæ•°æ®
            save_text_data("weibo", weibo_text_data)
            print(f"âœ… å¾®åšçˆ¬å–å®Œæˆï¼å…±ä¿å­˜ {len(weibo_text_data)} æ¡æ–‡æœ¬æ•°æ®")
        else:
            print("âŒ å¾®åšç™»å½•å¤±è´¥ï¼Œè·³è¿‡å¾®åšçˆ¬å–")

        # -------------------------- æµç¨‹ç»“æŸ --------------------------
        print("\n" + "="*60)
        print("ğŸ‰ æ‰€æœ‰å¹³å°æµç¨‹æ‰§è¡Œå®Œæˆï¼æ•°æ®å·²ä¿å­˜åˆ° ./data ç›®å½•")
        print("="*60)

    except Exception as e:
        print(f"\nâŒ ç¨‹åºæ‰§è¡Œå¼‚å¸¸ï¼š{str(e)}")
    finally:
        # 4. å…³é—­æµè§ˆå™¨ï¼ˆç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼‰
        input("\næŒ‰å›è½¦é”®å…³é—­æµè§ˆå™¨...")
        driver.quit()

if __name__ == "__main__":
    main()